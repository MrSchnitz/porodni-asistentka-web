# ============================================
# Deploy to Raspberry Pi
# ============================================
# 
# AutomatickÃ½ deployment na RPi server
# - Build ARM64 image
# - KopÃ­rovÃ¡nÃ­ pÅ™es Cloudflare Tunnel
# - Migrace databÃ¡ze
# - Restart aplikace
#
# ============================================
# REQUIRED SECRETS (GitHub â†’ Settings â†’ Secrets)
# ============================================
# SSH_PI_HOST            - SSH hostname pÅ™es Cloudflare (napÅ™. ssh.vase-domena.cz)
# SERVER_PI_USER         - SSH uÅ¾ivatel (napÅ™. pi)
# SSH_PI_PASSWORD        - Heslo pro SSH pÅ™Ã­stup na server
# POSTGRES_PI_PASSWORD   - Heslo pro PostgreSQL databÃ¡zi
#

name: Deploy to RPi

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        type: boolean
        default: false

env:
  IMAGE_NAME: porodni-asistentka-web
  SERVER_PATH: ~/apps/porodni-asistentka-test

jobs:
  # ============================================
  # Job 1: Build Docker image for ARM64
  # ============================================
  build:
    name: ðŸ”¨ Build ARM64 Image
    runs-on: ubuntu-latest
    outputs:
      image_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU (for ARM64 build)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate version
        id: version
        run: |
          VERSION="v${{ github.run_number }}-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: Build Docker image (ARM64)
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --tag ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            --tag ${{ env.IMAGE_NAME }}:latest \
            --output type=docker,dest=image.tar \
            .

      - name: Compress image
        run: |
          gzip image.tar
          ls -lh image.tar.gz
          echo "ðŸ“¦ Image size: $(du -h image.tar.gz | cut -f1)"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

  # ============================================
  # Job 2: Deploy to server and run migrations
  # ============================================
  deploy:
    name: ðŸš€ Deploy to RPi
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Install cloudflared and sshpass
        run: |
          # Install cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          cloudflared --version
          
          # Install sshpass for password-based auth
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Setup SSH with Cloudflare Tunnel
        run: |
          mkdir -p ~/.ssh
          
          # Configure SSH to use Cloudflare Tunnel
          cat >> ~/.ssh/config << EOF
          Host ${{ secrets.SSH_PI_HOST }}
              User ${{ secrets.SERVER_PI_USER }}
              ProxyCommand cloudflared access ssh --hostname %h
              StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Copy image to server
        env:
          SSHPASS: ${{ secrets.SSH_PI_PASSWORD }}
        run: |
          echo "ðŸ“¤ Copying image to server via Cloudflare Tunnel..."
          sshpass -e scp image.tar.gz ${{ secrets.SSH_PI_HOST }}:${{ env.SERVER_PATH }}/

      - name: Deploy on server
        env:
          SSHPASS: ${{ secrets.SSH_PI_PASSWORD }}
        run: |
          sshpass -e ssh ${{ secrets.SSH_PI_HOST }} << DEPLOY_SCRIPT
            set -e
            cd ${{ env.SERVER_PATH }}
            
            echo "ðŸ“¦ Loading Docker image..."
            docker load < image.tar.gz
            
            echo "ðŸ”„ Restarting application..."
            docker compose down app || true
            docker compose up -d
            
            echo "ðŸ§¹ Cleanup..."
            rm -f image.tar.gz
            docker image prune -f
            
            echo "âœ… Deployment complete!"
            docker compose ps
          DEPLOY_SCRIPT

      # ----------------------------------------
      # Database migrations (optional)
      # ----------------------------------------
      - name: Setup Node.js
        if: ${{ github.event.inputs.skip_migrations != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        if: ${{ github.event.inputs.skip_migrations != 'true' }}
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        if: ${{ github.event.inputs.skip_migrations != 'true' }}
        run: pnpm install --frozen-lockfile

      - name: Run migrations via SSH tunnel
        if: ${{ github.event.inputs.skip_migrations != 'true' }}
        env:
          POSTGRES_PI_PASSWORD: ${{ secrets.POSTGRES_PI_PASSWORD }}
          SSHPASS: ${{ secrets.SSH_PI_PASSWORD }}
        run: |
          echo "ðŸ”— Opening SSH tunnel to PostgreSQL via Cloudflare..."
          
          # Start SSH tunnel in background (through Cloudflare Tunnel)
          sshpass -e ssh -L 5432:localhost:5432 -N ${{ secrets.SSH_PI_HOST }} &
          TUNNEL_PID=$!
          sleep 5
          
          echo "ðŸ—ƒï¸ Running migrations..."
          DATABASE_URI="postgresql://payload:${POSTGRES_PI_PASSWORD}@localhost:5432/payload" \
            pnpm payload migrate
          
          echo "ðŸ”Œ Closing tunnel..."
          kill $TUNNEL_PID || true
          
          echo "âœ… Migrations complete!"

  # ============================================
  # Job 4: Verify deployment
  # ============================================
  # verify:
  #   name: âœ… Verify Deployment
  #   needs: [deploy, migrate]
  #   if: always() && needs.deploy.result == 'success'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Wait for app to start
  #       run: sleep 15

  #     - name: Check website
  #       run: |
  #         SITE_URL="${{ secrets.SITE_URL }}"
  #         if [ -z "$SITE_URL" ]; then
  #           echo "â­ï¸ SITE_URL secret not set, skipping verification"
  #           exit 0
  #         fi
          
  #         echo "ðŸ” Checking website at $SITE_URL..."
  #         HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          
  #         if [ "$HTTP_STATUS" = "200" ]; then
  #           echo "âœ… Website is up! (HTTP $HTTP_STATUS)"
  #         else
  #           echo "âš ï¸ Website returned HTTP $HTTP_STATUS"
  #         fi

  #     - name: Check admin panel
  #       run: |
  #         SITE_URL="${{ secrets.SITE_URL }}"
  #         if [ -z "$SITE_URL" ]; then
  #           exit 0
  #         fi
          
  #         echo "ðŸ” Checking admin panel..."
  #         HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/admin" || echo "000")
          
  #         if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
  #           echo "âœ… Admin panel is accessible! (HTTP $HTTP_STATUS)"
  #         else
  #           echo "âš ï¸ Admin panel returned HTTP $HTTP_STATUS"
  #         fi
